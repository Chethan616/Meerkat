<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs">
  <Package Name="Meerkat" 
           Language="1033" 
           Version="1.0.0.0" 
           Manufacturer="Chethan616" 
           UpgradeCode="F8A3C5D7-2B4E-4A1F-9E6D-8C7B5A4F3E2D">
    
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <Feature Id="ProductFeature" Title="Meerkat" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="DataFiles" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="DesktopShortcut" />
    </Feature>

    <Icon Id="MeerkatIcon.exe" SourceFile="$(var.SourceDir)\meerkat.exe" />
    <Property Id="ARPPRODUCTICON" Value="MeerkatIcon.exe" />
    <Property Id="ARPHELPLINK" Value="https://github.com/Chethan616/Meerkat" />

  </Package>

  <Fragment>
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="Meerkat">
        <Directory Id="DATAFOLDER" Name="data" />
      </Directory>
    </StandardDirectory>
    
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="Meerkat"/>
    </StandardDirectory>
    
    <StandardDirectory Id="DesktopFolder" />
  </Fragment>

  <Fragment>
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <!-- Main executable -->
      <Component Id="MeerkatApp" Guid="A1B2C3D4-E5F6-4A1B-8C9D-0E1F2A3B4C5D">
        <File Id="MeerkatExe" Source="$(var.SourceDir)\meerkat.exe" KeyPath="yes" />
        <File Id="MeerkatManifest" Source="$(var.SourceDir)\meerkat.exe.manifest" />
      </Component>
      
      <!-- All DLL files -->
      <Component Id="DllFiles" Guid="B2C3D4E5-F6A7-4B2C-9D0E-1F2A3B4C5D6E">
        <File Id="FlutterWindowsDll" Source="$(var.SourceDir)\flutter_windows.dll" />
        <File Id="ConnectivityPlusDll" Source="$(var.SourceDir)\connectivity_plus_plugin.dll" />
        <File Id="DesktopDropDll" Source="$(var.SourceDir)\desktop_drop_plugin.dll" />
        <File Id="DynamicColorDll" Source="$(var.SourceDir)\dynamic_color_plugin.dll" />
        <File Id="FileSelectorDll" Source="$(var.SourceDir)\file_selector_windows_plugin.dll" />
        <File Id="LocalAuthDll" Source="$(var.SourceDir)\local_auth_windows_plugin.dll" />
        <File Id="OpenDirDll" Source="$(var.SourceDir)\open_dir_windows_plugin.dll" />
        <File Id="PasteboardDll" Source="$(var.SourceDir)\pasteboard_plugin.dll" />
        <File Id="PermissionHandlerDll" Source="$(var.SourceDir)\permission_handler_windows_plugin.dll" />
        <File Id="RhttpDll" Source="$(var.SourceDir)\rhttp.dll" />
        <File Id="RustLibDll" Source="$(var.SourceDir)\rust_lib_meerkat.dll" />
        <File Id="ScreenRetrieverDll" Source="$(var.SourceDir)\screen_retriever_windows_plugin.dll" />
        <File Id="TrayManagerDll" Source="$(var.SourceDir)\tray_manager_plugin.dll" />
        <File Id="UriContentDll" Source="$(var.SourceDir)\uri_content_plugin.dll" />
        <File Id="UrlLauncherDll" Source="$(var.SourceDir)\url_launcher_windows_plugin.dll" />
        <File Id="WindowsTaskbarDll" Source="$(var.SourceDir)\windows_taskbar_plugin.dll" />
        <File Id="WindowManagerDll" Source="$(var.SourceDir)\window_manager_plugin.dll" />
      </Component>
      
      <!-- Data folder with all contents -->
      <Component Id="DataFolderComponent" Directory="INSTALLFOLDER" Guid="C3D4E5F6-A7B8-4C3D-0E1F-2A3B4C5D6E7F">
        <File Source="$(var.SourceDir)\data\app.so" KeyPath="yes" />
        <File Source="$(var.SourceDir)\data\icudtl.dat" />
      </Component>
      
      <!-- Flutter assets directory -->
      <Component Id="FlutterAssets" Directory="DATAFOLDER" Guid="F1F2F3F4-F5F6-4F1F-2F3F-4F5F6F7F8F9F">
        <CreateFolder />
        <util:RemoveFolderEx On="uninstall" Property="INSTALLFOLDER" />
        <RegistryValue Root="HKCU" Key="Software\Meerkat" Name="data" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>
    
    <!-- Copy entire data directory using CopyFile -->
    <ComponentGroup Id="DataFiles" Directory="INSTALLFOLDER">
      <Component Id="CopyDataDirectory" Guid="A2B3C4D5-E6F7-4A2B-3C4D-5E6F7A8B9C0D">
        <CopyFile Id="CopyDataFiles" 
                  SourceProperty="SourceDir" 
                  SourceName="data" 
                  DestinationProperty="INSTALLFOLDER" 
                  DestinationName="data" />
        <RegistryValue Root="HKCU" Key="Software\Meerkat" Name="datacopy" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Start Menu Shortcut -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="D4E5F6A7-B8C9-4D4E-1F2A-3B4C5D6E7F8A">
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="Meerkat"
                  Description="Secure File Sharing"
                  Target="[INSTALLFOLDER]meerkat.exe"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="MeerkatIcon.exe" />
        <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall"/>
        <RegistryValue Root="HKCU" Key="Software\Meerkat" Name="startmenu" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>

    <!-- Desktop Shortcut (Optional) -->
    <DirectoryRef Id="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="E5F6A7B8-C9D0-4E5F-2A3B-4C5D6E7F8A9B">
        <Shortcut Id="DesktopShortcut"
                  Name="Meerkat"
                  Description="Secure File Sharing"
                  Target="[INSTALLFOLDER]meerkat.exe"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="MeerkatIcon.exe" />
        <RegistryValue Root="HKCU" Key="Software\Meerkat" Name="desktop" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>
  </Fragment>
</Wix>
