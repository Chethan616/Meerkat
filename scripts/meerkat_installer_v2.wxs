<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <Package Name="Meerkat" 
           Language="1033" 
           Version="1.0.0.0" 
           Manufacturer="Chethan616" 
           UpgradeCode="F8A3C5D7-2B4E-4A1F-9E6D-8C7B5A4F3E2D">
    
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <Feature Id="ProductFeature" Title="Meerkat" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="DesktopShortcut" />
    </Feature>

    <Icon Id="MeerkatIcon.exe" SourceFile="$(var.SourceDir)\meerkat.exe" />
    <Property Id="ARPPRODUCTICON" Value="MeerkatIcon.exe" />
    <Property Id="ARPHELPLINK" Value="https://github.com/Chethan616/Meerkat" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/Chethan616/Meerkat" />
    
    <!-- Interactive UI Configuration -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    
    <ui:WixUI Id="WixUI_InstallDir" />
    
    <!-- Use standard images - no custom overlays -->
    <WixVariable Id="WixUILicenseRtf" Value="$(var.ProjectDir)\License.rtf" />

    <!-- Custom action to copy data folder -->
    <CustomAction Id="CopyDataFolder"
                  Directory="INSTALLFOLDER"
                  ExeCommand="cmd.exe /c xcopy &quot;$(var.SourceDir)\data&quot; &quot;[INSTALLFOLDER]data\&quot; /E /I /Y"
                  Execute="deferred"
                  Impersonate="no"
                  Return="check" />

    <InstallExecuteSequence>
      <Custom Action="CopyDataFolder" After="InstallFiles" Condition="NOT Installed" />
    </InstallExecuteSequence>

  </Package>

  <Fragment>
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="Meerkat" />
    </StandardDirectory>
    
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="Meerkat"/>
    </StandardDirectory>
    
    <StandardDirectory Id="DesktopFolder" />
  </Fragment>

  <Fragment>
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <!-- Main executable and manifest -->
      <Component Id="MeerkatApp" Guid="A1B2C3D4-E5F6-4A1B-8C9D-0E1F2A3B4C5D">
        <File Id="MeerkatExe" Source="$(var.SourceDir)\meerkat.exe" KeyPath="yes" />
        <File Id="MeerkatManifest" Source="$(var.SourceDir)\meerkat.exe.manifest" />
      </Component>
      
      <!-- All DLL files -->
      <Component Id="DllFiles" Guid="B2C3D4E5-F6A7-4B2C-9D0E-1F2A3B4C5D6E">
        <File Source="$(var.SourceDir)\flutter_windows.dll" />
        <File Source="$(var.SourceDir)\connectivity_plus_plugin.dll" />
        <File Source="$(var.SourceDir)\desktop_drop_plugin.dll" />
        <File Source="$(var.SourceDir)\dynamic_color_plugin.dll" />
        <File Source="$(var.SourceDir)\file_selector_windows_plugin.dll" />
        <File Source="$(var.SourceDir)\local_auth_windows_plugin.dll" />
        <File Source="$(var.SourceDir)\open_dir_windows_plugin.dll" />
        <File Source="$(var.SourceDir)\pasteboard_plugin.dll" />
        <File Source="$(var.SourceDir)\permission_handler_windows_plugin.dll" />
        <File Source="$(var.SourceDir)\rhttp.dll" />
        <File Source="$(var.SourceDir)\rust_lib_meerkat.dll" />
        <File Source="$(var.SourceDir)\screen_retriever_windows_plugin.dll" />
        <File Source="$(var.SourceDir)\tray_manager_plugin.dll" />
        <File Source="$(var.SourceDir)\uri_content_plugin.dll" />
        <File Source="$(var.SourceDir)\url_launcher_windows_plugin.dll" />
        <File Source="$(var.SourceDir)\windows_taskbar_plugin.dll" />
        <File Source="$(var.SourceDir)\window_manager_plugin.dll" />
      </Component>
      
      <!-- Registry marker for uninstall cleanup -->
      <Component Id="RegistryEntries" Guid="C3D4E5F6-A7B8-4C3D-0E1F-2A3B4C5D6E7F">
        <RegistryValue Root="HKCU" Key="Software\Meerkat" Name="installed" Type="integer" Value="1" KeyPath="yes" />
        <util:RemoveFolderEx On="uninstall" Property="INSTALLFOLDER" />
      </Component>
    </ComponentGroup>

    <!-- Start Menu Shortcut -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationShortcut" Guid="D4E5F6A7-B8C9-4D4E-1F2A-3B4C5D6E7F8A">
        <Shortcut Id="ApplicationStartMenuShortcut"
                  Name="Meerkat"
                  Description="Secure File Sharing"
                  Target="[INSTALLFOLDER]meerkat.exe"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="MeerkatIcon.exe" />
        <RemoveFolder Id="CleanUpShortCut" On="uninstall"/>
        <RegistryValue Root="HKCU" Key="Software\Meerkat" Name="startmenu" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </DirectoryRef>
  </Fragment>

  <!-- Desktop Shortcut -->
  <Fragment>
    <StandardDirectory Id="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="E5F6A7B8-C9D0-4E5F-2A3B-4C5D6E7F8A9B">
        <Shortcut Id="DesktopShortcut"
                  Name="Meerkat"
                  Description="Secure File Sharing"
                  Target="[INSTALLFOLDER]meerkat.exe"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="MeerkatIcon.exe" />
        <RegistryValue Root="HKCU" Key="Software\Meerkat" Name="desktop" Type="integer" Value="1" KeyPath="yes"/>
      </Component>
    </StandardDirectory>
  </Fragment>
</Wix>
